<div class="main-container" fxLayout="row" fxLayoutAlign="center center">

  <div fxFlex="90">
    <mat-toolbar color="accent">
      <mat-toolbar-row>        
        <div class="main-icon">
            <a routerLink="/admin/blog">
              <mat-icon>create</mat-icon>
            </a>
        </div>
        <div>
          <a routerLink="/admin/blog">
            <strong>Blog</strong>
          </a>
        </div>
        <div class="main-icon">&nbsp;&nbsp;&nbsp;<mat-icon>chevron_right</mat-icon>&nbsp;&nbsp;&nbsp;</div>
        <div>Crear publicación</div>
        <span class="spacer"></span>
        <button type="button" routerLink="/admin" mat-icon-button matTooltip="Volver al Dashboard">
          <mat-icon>chevron_left</mat-icon>
        </button>
      </mat-toolbar-row>
    </mat-toolbar>
  </div>

</div>

<form [formGroup]="articleForm" (ngSubmit)="save()" novalidate>

  <!-- BASIC INFO -->
  <div class="block" fxLayout="row" fxLayoutAlign="center center">
    <div fxFlex="90">

      <mat-card>
        <mat-card-title>Información básica</mat-card-title>
        <mat-card-subtitle>Añade la información básica para generar la URL del artículo</mat-card-subtitle>

        <!-- TITLE -->
        <mat-form-field appearance="outline" style="width: 100%;">
          <mat-label>Títular</mat-label>
          <input matInput #title name="title" formControlName="title" maxlength="120" placeholder="Titular" [errorStateMatcher]="customErrorStateMatcher" required>
          <span matSuffix>{{ title.value.length }}</span>
          <mat-hint>Máximo 120 caracteres</mat-hint>
          <mat-error>Debes introducir un título</mat-error>
        </mat-form-field>
        <!-- /TITLE -->

        <div class="type-category-container" fxLayout="row" fxLayout.xs="column" fxLayoutAlign="space-between center" fxLayoutAlign.xs="center center">
          <div fxFlex="48" fxFlex.xs="100">
            <!-- ARTICLE TYPE -->
            <mat-form-field appearance="outline">
              <mat-label>Tipo de artículo</mat-label>
              <input matInput #template formControlName="template" [matAutocomplete]="templateAutocomplete" placeholder="Tipo de artículo" required>
              <button type="button" mat-button *ngIf="template.value" matSuffix mat-icon-button aria-label="Borrar" (click)="articleForm.get('template').setValue(null)">
                <mat-icon>close</mat-icon>
              </button>
              <mat-error>Debes seleccionar un tipo de artículo</mat-error>
            </mat-form-field>
            <mat-autocomplete #templateAutocomplete="matAutocomplete" [displayWith]="displayTemplateFn">
              <mat-option *ngFor="let template of filteredArticlesTemplate | async" [value]="template">
                {{ template.name }}
              </mat-option>
            </mat-autocomplete>
            <!-- /ARTICLE TYPE -->
          </div>
          <div fxFlex="48" fxFlex.xs="100">

            <!-- CATEGORY -->
            <div fxLayout="row" fxLayoutAlign="center center">
              <div fxFlex="95">
                <mat-form-field appearance="outline">
                  <mat-label>Categoría</mat-label>
                  <input matInput #category formControlName="category" [matAutocomplete]="categoryAutocomplete" placeholder="Categoría" required>
                  <button type="button" mat-button *ngIf="category.value && !loadingCategories" matSuffix mat-icon-button aria-label="Borrar" (click)="articleForm.get('category').setValue(null)">
                    <mat-icon>close</mat-icon>
                  </button>
                  <mat-error>Debes elegir una categoría</mat-error>
                </mat-form-field>
                <mat-autocomplete #categoryAutocomplete="matAutocomplete" [displayWith]="displayCategoryFn">
                  <mat-option *ngFor="let category of filteredArticlesCategory | async" [value]="category">
                    <div class="category-name">{{ category.name }}</div>
                  </mat-option>
                </mat-autocomplete>
              </div>
              <div fxFlex="5">
                <div style="margin-top: -12px;">
                  <button type="button" mat-icon-button (click)="openCreateCategoryDialog()" color="primary" matTooltip="Añadir categoría"><mat-icon>add</mat-icon></button>
                </div>
              </div>
            </div>
            <!-- /CATEGORY -->

          </div>
        </div>

        <div class="url-container" fxLayout="row" fxLayout.xs="column" fxLayoutAlign="center center">
          <div fxFlex="100">
            <h4>
              <div class="link-icon-div"><mat-icon>link</mat-icon></div>
              <div>&nbsp;URL del artículo</div>
            </h4>
            <p>https://ict.com/<span class="url-background">{{ articleForm.value.slug }}</span></p>
          </div>
        </div>

      </mat-card>

    </div>
  </div>
  <!-- /BASIC INFO -->

  <!-- OPINION - AUTHOR -->
  <div class="block author" fxLayout="row" fxLayoutAlign="center center" *ngIf="articleForm.value.template && (articleForm.value.template.value === 'opinion')" [@fadeAnimation]="'in'">
    <div fxFlex="90">
      <mat-card>
        <mat-card-title>Autor</mat-card-title>
        <mat-card-subtitle>Especifica el autor del artículo de opinión</mat-card-subtitle>

        <div fxLayout="row" fxLayoutAlign="start center">
          <div fxFlex="50">
            <!-- EXTERNAL AUTHOR AUTOCOMPLETE -->
            <mat-form-field appearance="outline">
              <mat-label>Autor externo</mat-label>
              <input matInput #external_author formControlName="external_author_aux" [matAutocomplete]="externalAuthorAutocomplete" placeholder="Autor externo">
              <button mat-button *ngIf="external_author.value && !loadingAuthors" matSuffix mat-icon-button aria-label="Borrar" (click)="articleForm.get('external_author_aux').setValue(null)">
                <mat-icon>close</mat-icon>
              </button>
              <mat-progress-spinner *ngIf="loadingAuthors" matSuffix color="primary" diameter="25" mode="indeterminate"></mat-progress-spinner>
            </mat-form-field>
            <mat-autocomplete #externalAuthorAutocomplete="matAutocomplete" [displayWith]="displayExternalAuthorFn">
              <mat-option *ngFor="let external_author of filteredArticlesExternalAuthor | async" [value]="external_author">
                <div class="container" fxLayout="row" fxLayoutAlign="start center">
                  <div class="avatar" [ngStyle]="{ 'background-image': external_author.thumbnail ? 'url(' + external_author.thumbnail + ')' : 'none' }"></div>
                  <div class="name">{{ external_author.name  }}</div>
                </div>
              </mat-option>
            </mat-autocomplete>
            <!-- /EXTERNAL AUTHOR AUTOCOMPLETE -->
          </div>
          <div fxFlex="50" class="create-button-container">
            <button type="button" mat-raised-button color="info" (click)="openCreateAuthorDialog();">Crear autor</button>
          </div>
        </div>

        <mat-divider [inset]="true"></mat-divider>

        <div class="current-author" fxLayout="row" fxLayoutAlign="start start">
          <div>
            <img [src]="articleForm.value.external_author ? articleForm.value.external_author.thumbnail : user.thumbnail ? user.thumbnail : '/assets/img/user-image.png'" alt="{{ articleForm.value.external_author ? articleForm.value.external_author.name : user.fullname }}" class="avatar" />
          </div>
          <div class="current-author-info">
            <h4>Autor actual</h4>
            <h3>{{ articleForm.value.external_author ? articleForm.value.external_author.name : user.fullname }} <small>{{ articleForm.value.external_author ? 'Autor externo' : 'Instituto Canario de las Tradiciones' }}</small></h3>
            <p *ngIf="articleForm.value.external_author">{{ articleForm.value.external_author.bio }}</p>
            <p *ngIf="!articleForm.value.external_author">{{ user.bio ? user.bio : 'Sin biografía' }}</p>
            <div *ngIf="articleForm.value.external_author">
              <button type="button" [swal]="authorDeletionAlert" mat-icon-button matTooltip="Borrar autor" color="warn" (confirm)="deleteAuthor();">
                <mat-icon>delete</mat-icon>
              </button>
              <button type="button" mat-icon-button matTooltip="Editar autor" (click)="openCreateAuthorDialog(articleForm.value.external_author)" color="info">
                <mat-icon>create</mat-icon>
              </button>
              <button type="button" mat-icon-button matTooltip="Quitar autor externo" color="accent" (click)="articleForm.get('external_author_aux').setValue(null)">
                <mat-icon>clear</mat-icon>
              </button>
            </div>
          </div>
        </div>


      </mat-card>
    </div>
  </div>
  <!-- /OPINION - AUTHOR -->

  <!-- INTERVIEWEES -->
  <div class="block interview" fxLayout="row" fxLayoutAlign="center center" *ngIf="articleForm.value.template && (articleForm.value.template.value === 'interview' || articleForm.value.template.value === 'profile')" [@fadeAnimation]="'in'">
    <div fxFlex="90">
      <mat-card>
        <mat-card-title>{{ articleForm.value.template.value === 'interview' ? 'Entrevistado' : 'Perfil' }}</mat-card-title>
        <mat-card-subtitle>Especifica el nombre y el cargo {{ articleForm.value.template.value === 'interview' ? 'del entrevistado' : 'de la persona de la que se hace el perfil' }}</mat-card-subtitle>

        <div fxLayout="row" fxLayoutAlign="center center">
          <div fxLayout="50" class="input-container margin-right">
            <mat-form-field appearance="outline" [ngStyle]="{'font-size.px': '12' }" style="width: 100%;">
              <mat-label>Nombre</mat-label>
              <input matInput #interview_interviewee name="interview_interviewee" formControlName="interview_interviewee" placeholder="Nombre del entrevistado" [errorStateMatcher]="confirmValidParentMatcher" required>
              <mat-error>Debes introducir el nombre del entrevistado</mat-error>
            </mat-form-field>
          </div>
          <div fxLayout="50" class="input-container margin-left">
            <mat-form-field appearance="outline" [ngStyle]="{'font-size.px': '12' }" style="width: 100%;">
              <mat-label>Cargo</mat-label>
              <input matInput #interview_occupation name="interview_occupation" formControlName="interview_occupation" placeholder="Cargo del entrevistado" [errorStateMatcher]="confirmValidParentMatcher" required>
              <mat-error>Debes introducir el cargo del entrevistado</mat-error>
            </mat-form-field>
          </div>
        </div>

      </mat-card>
    </div>
  </div>
  <!-- /INTERVIEWEES -->

  <!-- ARTICLE HEADER - IMAGE OR VIDEO -->
  <div class="block" fxLayout="row" fxLayoutAlign="center center" *ngIf="articleForm.value.template && (articleForm.value.template.value === 'news' || articleForm.value.template.value === 'article' || articleForm.value.template.value === 'interview' || articleForm.value.template.value === 'profile' || articleForm.value.template.value === 'opinion')" [@fadeAnimation]="'in'">
    <div fxFlex="90">
      <mat-card>
        <mat-card-title>Cabecera</mat-card-title>
        <mat-card-subtitle>El motivo audiovisual con el que abrirá el artículo</mat-card-subtitle>

        <div fxLayout="column" fxLayoutAlign="center center" style="width: 100%;">
          <p>Selecciona qué tipo de cabecera quieres para el artículo</p>
          <mat-button-toggle-group formControlName="header_mode" name="header" aria-label="Cabecera">
            <mat-button-toggle value="image"><mat-icon>image</mat-icon>&nbsp;&nbsp;Imagen</mat-button-toggle>
            <mat-button-toggle value="video"><mat-icon>videocam</mat-icon>&nbsp;&nbsp;Vídeo</mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        <div class="header-image" *ngIf="articleForm.value.header_mode === 'image'" fxLayout="row" fxLayoutAlign="center start">
          
          <div fxFlex="50" class="header-drag-drop-container">
            <div class="header-drag-drop" ng2FileDrop [ngClass]="{ 'drag-drop-container-over': headerHasBaseDropZoneOver }" (fileOver)="headerOverBase($event)" (onFileDrop)="headerDroppedOverBase($event)" [uploader]="headerUploader" fxLayout="row" fxLayoutAlign="center center">
              <div>Arrastra una imagen a aquí</div>
            </div>
            <input type="file" mat-button ng2FileSelect (onFileSelected)="headerDroppedOverBase($event)" [uploader]="headerUploader" />
            <p *ngIf="articleForm.hasError('imageRequired') && articleFormSubmitted" class="error">Debes subir una imagen para utilizar como cabecera del artículo</p>
          </div>
          
          <div fxFlex="50" class="header-image-preview-container">
            
            <div fxLayout="column" fxLayoutAlign="center center" *ngFor="let item of headerUploader.queue">
              <div>
                <img src mediaPreview [media]="item?._file" class="media-object" />
                <div *ngIf="item.isUploading || item.isSuccess" class="progress-bar-container">
                  <mat-progress-bar #headerProgress mode="determinate" value="{{ item.progress }}"></mat-progress-bar>
                </div>
              </div>
              <div>
                <button type="button" mat-raised-button color="success" (click)="item.upload()" [disabled]="item.isReady || item.isUploading || item.isSuccess">
                  <mat-icon>cloud_upload</mat-icon>&nbsp;Subir
                </button>
                <button type="button" mat-raised-button color="accent" (click)="item.cancel()" [disabled]="!item.isUploading">
                  <mat-icon>not_interested</mat-icon>&nbsp;Cancelar
                </button>
                <button type="button" mat-raised-button color="warn" (click)="item.remove()">
                  <mat-icon>delete</mat-icon>&nbsp;Borrar
                </button>
              </div>
            </div>

            <div class="header-image-no-preview-container" *ngIf="headerUploader.queue.length === 0" fxLayout="row" fxLayoutAlign="center center">
              <div><h3>PREVISUALIZACIÓN</h3></div>
            </div>

            <div class="buttons" *ngIf="headerUploader.queue.length > 0">
            </div>

          </div>
        </div>

        <div formGroupName="video" class="header-video" *ngIf="articleForm.value.header_mode === 'video'" fxLayout="column" fxLayoutAlign="center center">
          <div class="header-video-input-container">
            <mat-form-field appearance="outline">
              <mat-label>Enlace de YouTube</mat-label>
              <input matInput #video name="video" formControlName="url" placeholder="Introduce el enlace del vídeo de YouTube">
            </mat-form-field>
          </div>
          <div *ngIf="articleForm.value.video.url && YouTubeValidUrl" class="header-video-preview-container">
            <div fxLayout="row" fxLayoutAlign="center start">
              <div class="video" fxFlex="50">
                <p><strong>Vídeo</strong></p>
                <iframe [src]="cleanUrl(articleForm.value.video.embed)" frameborder="0" allowfullscreen></iframe>
              </div>
              <div class="preview" fxFlex="50">
                <p><strong>Previsualización</strong></p>
                <img [src]="articleForm.value.video.frame" alt="Previsualización de vídeo de YouTube" />
              </div>
            </div>
          </div>
          <div *ngIf="articleForm.value.video.url && !YouTubeValidUrl">
            <p class="error">La URL es errónea o no corresponde con ninguna URL de YouTube</p>
          </div>
          <div *ngIf="articleForm.hasError('videoRequired') && articleFormSubmitted">
            <p class="error">Debes agregar un vídeo de YouTube para utilizar como cabecera del artículo</p>
          </div>
        </div>

      </mat-card>
    </div>
  </div>
  <!-- /ARTICLE HEADER - IMAGE OR VIDEO -->

  <!-- CONTENT -->
  <div class="block" fxLayout="row" fxLayoutAlign="center center" *ngIf="articleForm.value.template && (articleForm.value.template.value === 'news' || articleForm.value.template.value === 'article' || articleForm.value.template.value === 'interview')" [@fadeAnimation]="'in'">
    <div fxFlex="90">
      <mat-card>
        <mat-card-title>Contenido del artículo</mat-card-title>
        <mat-card-subtitle>El contenido del artículo</mat-card-subtitle>
        <quill-editor formControlName="content" [modules]="contentModules" placeholder="Escribe el texto aquí" required></quill-editor>
        <div class="counter" id="shortCounter"></div>
        <div *ngIf="articleForm.get('content').hasError('required') && articleFormSubmitted">
          <p class="error">El artículo debe tener un texto de contenido</p>
        </div>
      </mat-card>
    </div>
  </div>
  <!-- /CONTENT -->

  <!-- GALLERY -->
  <div class="block" fxLayout="row" fxLayoutAlign="center center" *ngIf="articleForm.value.template && (articleForm.value.template.value === 'news' || articleForm.value.template.value === 'article' || articleForm.value.template.value === 'interview' || articleForm.value.template.value === 'profile' || articleForm.value.template.value === 'opinion')" [@fadeAnimation]="'in'">
    <div fxFlex="90">
      <mat-card>
        <mat-card-title>Galería de imágenes</mat-card-title>
        <mat-card-subtitle>
          <mat-slide-toggle formControlName="gallery_enabled">Activar galería de imágenes</mat-slide-toggle>
        </mat-card-subtitle>
        <div *ngIf="articleForm.value.gallery_enabled">
          <div class="gallery-drag-drop" ng2FileDrop [ngClass]="{ 'drag-drop-container-over': galleryHasBaseDropZoneOver }" (fileOver)="galleryOverBase($event)" (onFileDrop)="galleryDroppedOverBase($event)" [uploader]="galleryUploader" fxLayout="row" fxLayoutAlign="center center">
            <div>Arrastra a aquí tus imágenes</div>
          </div>
          <input type="file" mat-button ng2FileSelect (onFileSelected)="galleryDroppedOverBase($event)" [uploader]="galleryUploader" />
        </div>
        <div class="gallery-progress-bar-container" *ngIf="articleForm.value.gallery_enabled && (galleryUploader.getNotUploadedItems().length > 0 || (articleForm.value.gallery.length > 0))">
          <div class="left-progress">{{ galleryUploader.progress }}%</div>
          <div *ngIf="galleryUploader.getNotUploadedItems().length === 0 && articleForm.value.gallery.length > 0" class="right-icon"><mat-icon>check_circle_outline</mat-icon></div>
          <mat-progress-bar #galleryProgress mode="determinate" value="{{ galleryUploader.progress }}"></mat-progress-bar>
        </div>

        <div *ngIf="galleryUploader.getNotUploadedItems().length > 0 || (articleForm.value.gallery.length > 0)" class="gallery-images-container" fxLayout="column" fxLayoutAlign="center start">
          <div class="not-uploaded-title">
            <strong>Imágenes añadidas</strong><br />
            <span *ngIf="galleryUploader.getNotUploadedItems().length > 0" class="not-uploaded">Hay {{ galleryUploader.queue.length }} imagenes pendientes de ser subidas</span>
            <span *ngIf="galleryUploader.getNotUploadedItems().length === 0">Todas las imágenes han sido correctamente subidas</span>
            <button type="button" mat-raised-button matTooltip="Subir todas las imágenes" color="success" (click)="galleryUploader.uploadAll()" [disabled]="!galleryUploader.getNotUploadedItems().length">
              <mat-icon>cloud_upload</mat-icon>&nbsp;Subir
            </button>
            <button type="button" mat-raised-button matTooltip="Cancelar subida de imágenes" color="accent" (click)="galleryUploader.cancelAll()" [disabled]="!galleryUploader.isUploading">
              <mat-icon>not_interested</mat-icon>&nbsp;Cancelar
            </button>
            <button type="button" mat-raised-button matTooltip="Borrar todas las imágenes" color="warn" (click)="galleryUploader.clearQueue()" [disabled]="!galleryUploader.queue.length">
              <mat-icon>delete</mat-icon>&nbsp;Borrar
            </button>
          </div>
          <div class="not-uploaded-container">
            <div fxLayout="row wrap" fxLayoutAlign="space-around center" fxLayoutGap="10px">
              <div class="image-container mat-elevation-z8" fxFlex="20" *ngFor="let item of galleryUploader.queue">
                <img src mediaPreview [media]="item?._file" class="media-object" />
                <div *ngIf="item.isUploading || item.isSuccess" class="progress-bar-container">
                  <mat-progress-bar #galleryImageProgress mode="determinate" value="{{ item.progress }}"></mat-progress-bar>
                </div>
                <div>
                  <button type="button" mat-icon-button color="success" matTooltip="Subir imagen" (click)="item.upload()" [disabled]="item.isReady || item.isUploading || item.isSuccess">
                    <mat-icon>cloud_upload</mat-icon>
                  </button>
                  <button type="button" mat-icon-button color="accent" matTooltip="Cancelar subida" (click)="item.cancel()" [disabled]="!item.isUploading">
                    <mat-icon>not_interested</mat-icon>
                  </button>
                  <button type="button" mat-icon-button color="warn" matTooltip="Borrar imagen" (click)="item.remove()">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </mat-card>
    </div>
  </div>
  <!-- /GALLERY -->

</form>

<div class="post-tools mat-elevation-z8" [ngStyle]="{ 'right': areToolsExpanded ? '0' : '-365px' }">
  <button type="button" mat-icon-button matTooltip="{{ !areToolsExpanded ? 'Expandir' : 'Ocultar' }}" [matTooltipPosition]="'left'"  (click)="areToolsExpanded = !areToolsExpanded">
    <mat-icon *ngIf="!areToolsExpanded">chevron_left</mat-icon>
    <mat-icon *ngIf="areToolsExpanded">chevron_right</mat-icon>
  </button>
  <button type="button" mat-stroked-button color="warn">Cancelar</button>
  <button type="button" mat-stroked-button color="info">Vista previa</button>
  <button type="submit" mat-stroked-button color="success" (click)="save();" [disabled]="articleForm.pristine">Guardar</button>
  <div *ngIf="articleForm.pristine && articleForm.untouched && areToolsExpanded"><p>Rellena el formulario para activar el botón "Guardar"</p></div>
  <div *ngIf="articleForm.invalid && (articleForm.touched || articleForm.dirty) && !articleFormSubmitted && areToolsExpanded"><p>El formulario aún no está completo, revísalo</p></div>
  <div *ngIf="articleForm.invalid && articleFormSubmitted && areToolsExpanded"><p class="error">El formulario contiene errores, revísalo</p></div>
  <div *ngIf="articleForm.valid && areToolsExpanded" class="success"><p><strong>El artículo está completo, puedes enviarlo</strong></p></div>
</div>